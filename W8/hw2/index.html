<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="style.css">
    <title>Document</title>
</head>

<body>
    <nav>
        <div class="game__nav">
        </div>
        <div class="game__nav">
        </div>
        <div class="game__nav">
        </div>
        <div class="game__nav">
        </div>
        <div class="game__nav">
        </div>
    </nav>
    <div class="container">
    </div>
</body>
<script>
    const container = document.querySelector('.container')

    //page initialize
    const request = new XMLHttpRequest()
    request.open('GET', 'https://api.twitch.tv/helix/games/top?first=5')
    SendReq()
    request.onload = () => {
        if (request.status >= 200 && request.status <= 400) {
            const top5Game = JSON.parse(request.responseText)
            let games = document.querySelectorAll('.game__nav')

            games.forEach((games, index) => {
                games.innerHTML = (`${top5Game.data[index].name}`)
                games.setAttribute("game-id", `${top5Game.data[index].id}`)
            })
        }
    }

    // event render
    document.querySelector('nav').addEventListener('click', (e) => {
        if (e.target.classList.contains('game__nav')) {

            let gameId = e.target.getAttribute("game-id");

            request.open('GET', `https://api.twitch.tv/helix/streams?game_id=${gameId}`)
            SendReq()
            request.onload = () => {
                if (request.status >= 200 && request.status <= 400) {
                    // clear the container
                    container.innerHTML = ""

                    const streamData = JSON.parse(request.responseText)
                    let userId = ""

                    for (let i = 0; i < streamData.data.length; i++) {

                        let streamImg = streamData.data[i].thumbnail_url.replace('{width}x{height}', '400x225')

                        let streamBox = document.createElement('div')
                        streamBox.classList.add('game__stream')
                        streamBox.setAttribute("user-id", streamData.data[i].user_id)
                        streamBox.innerHTML = `<img src = "${streamImg}">
                                                    <div><img>
                                                        <div class="stream__info">
                                                            <div class="stream__title">${streamData.data[i].title}</div>
                                                            <div class="stream__user">${streamData.data[i].user_name}</div>
                                                        <div>
                                                    </div>`
                        container.appendChild(streamBox)
                        userId += `id=${streamData.data[i].user_id}&`
                    }
                    GetUserIcon(userId)
                }
            }
        }
    })

    function GetUserIcon(id) {
        request.open('GET', `https://api.twitch.tv/helix/users?${id}`)
        SendReq()
        request.onload = () => {
            if (request.status >= 200 && request.status <= 400) {
                let data = (JSON.parse(request.responseText)).data;
                for (let i = 0; i < data.length; i++) {
                    document.querySelector(`div[user-id="${data[i].id}"] div img`).setAttribute("src", data[i].profile_image_url)    
                }
            }
        }
    }

    // request send
    function SendReq() {
        request.setRequestHeader('Authorization', 'Bearer poueccxbhpzuult7cnukizpl3wpwoo')
        request.setRequestHeader('Client-Id', 'mqe2bm3baevz9kp0faykakz5op13nv')
        request.send()
    }
</script>

</html>