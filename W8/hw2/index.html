<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="style.css">
    <title>Document</title>
</head>

<body>
    <nav>
        <div class="game__nav">
        </div>
        <div class="game__nav">
        </div>
        <div class="game__nav">
        </div>
        <div class="game__nav">
        </div>
        <div class="game__nav">
        </div>
    </nav>
    <div class="container">
    </div>
</body>
<script>
    var iconUrl = ""
    const container = document.querySelector('.container')
    //page initialize
    const request = new XMLHttpRequest()
    request.open('GET', 'https://api.twitch.tv/helix/games/top?first=5')
    SendReq()

    // render 
    request.onload = () => {
        if (request.status >= 200 && request.status <= 400) {
            const top5Game = JSON.parse(request.responseText)

            let games = document.querySelectorAll('.game__nav')

            games.forEach((games, index) => {
                games.innerHTML = (`${top5Game.data[index].name}`)
            })
        }
    }

    // event render
    document.querySelector('nav').addEventListener('click', (e) => {
        if (e.target.classList.contains('game__nav')) {
            let gameName = e.target.innerText

            // send game name to get game id
            request.open('GET', `https://api.twitch.tv/helix/games?name=${gameName}`)
            SendReq()
            request.onload = () => {
                if (request.status >= 200 && request.status <= 400) {
                    const gameData = JSON.parse(request.responseText)
                    const gameId = gameData.data[0].id

                    // send game id to get stream data
                    request.open('GET', `https://api.twitch.tv/helix/streams?game_id=${gameId}`)
                    SendReq()

                    request.onload = () => {
                        container.innerHTML = ""
                        if (request.status >= 200 && request.status <= 400) {
                            const streamData = JSON.parse(request.responseText)
                            for (let i = 0; i < 20; i++) {
                                const streams = document.createElement('div')
                                streams.classList.add('game__stream')
                                GetUserIcon(streamData.data[i].user_id)
                                
                                let url = streamData.data[i].thumbnail_url.replace('{width}x{height}', '400x225')

                                streams.innerHTML = `<img src = "${url}"> <div><img src="${iconUrl}" id=img__${i}>${streamData.data[i].user_name}</div>`
                                container.appendChild(streams)           
                            }
                        }
                    }
                }
            }
        }
    })

    function GetUserIcon(id) {
        request.open('GET', `https://api.twitch.tv/helix/users?id=${id}`)
        SendReq()
        request.onload = () => {
            if (request.status >= 200 && request.status <= 400) {
                const userData = JSON.parse(request.responseText)
                GetUrl(userData.data[0].profile_image_url)
            }
        }
    }

    function GetUrl(url){
        iconUrl = url
    }

    // request send
    function SendReq() {
        request.setRequestHeader('Authorization', 'Bearer poueccxbhpzuult7cnukizpl3wpwoo')
        request.setRequestHeader('Client-Id', 'mqe2bm3baevz9kp0faykakz5op13nv')
        request.send()
    }
</script>

</html>